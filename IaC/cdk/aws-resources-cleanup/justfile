# AWS Resources Cleanup - CDK Deployment Automation
# Usage: just <command>

# Default AWS profile and region
profile := env_var_or_default("AWS_PROFILE", "percona-dev-admin")
region := env_var_or_default("AWS_REGION", "us-east-2")

# Lambda function name from CDK stack outputs (dynamically retrieved)
# This ensures justfile always uses the function name defined in the CDK stack
# Falls back to "LambdaAWSResourceCleanup" if stack doesn't exist yet
lambda_function := `aws cloudformation describe-stacks --stack-name AWSResourcesCleanupStack --profile percona-dev-admin --region us-east-2 --query "Stacks[0].Outputs[?OutputKey=='LambdaFunctionName'].OutputValue | [0]" --output text 2>/dev/null || echo "LambdaAWSResourceCleanup"`

# Default recipe - show available commands
default:
    @echo "AWS Resources Cleanup - CDK Deployment"
    @echo ""
    @echo "Quick Start:"
    @echo "  just install          Install dependencies"
    @echo "  just deploy           Deploy in DRY_RUN mode (safe)"
    @echo "  just logs             Tail CloudWatch logs"
    @echo "  just invoke-aws       Test Lambda execution"
    @echo ""
    @echo "Deployment:"
    @echo "  just deploy           Deploy in DRY_RUN mode (default)"
    @echo "  just deploy-live      Deploy in LIVE mode (destructive!)"
    @echo "  just diff             Preview infrastructure changes"
    @echo "  just synth            Generate CloudFormation template"
    @echo "  just destroy          Destroy the entire stack"
    @echo ""
    @echo "Monitoring:"
    @echo "  just logs             Tail CloudWatch logs (follow)"
    @echo "  just logs-recent      Show logs from last hour"
    @echo "  just invoke-aws       Manually invoke Lambda"
    @echo "  just info             Show Lambda configuration"
    @echo "  just outputs          Show stack outputs"
    @echo "  just params           Show stack parameters"
    @echo ""
    @echo "Testing & Quality:"
    @echo "  just test             Run unit tests"
    @echo "  just test-coverage    Run tests with detailed coverage"
    @echo "  just lint             Run linters"
    @echo "  just format           Format code"
    @echo "  just ci               Full CI pipeline (lint + test + synth)"
    @echo ""
    @echo "Maintenance:"
    @echo "  just update-code      Fast Lambda code update (no CDK)"
    @echo "  just upgrade          Upgrade all dependencies"
    @echo "  just versions         Show installed versions"
    @echo "  just clean            Clean build artifacts"
    @echo "  just validate         Validate CloudFormation template"
    @echo ""
    @echo "Run 'just --list' for all commands"

# Install dependencies
install:
    @echo "Installing CDK and Lambda dependencies..."
    uv pip install -r requirements.txt
    @echo "Installing Lambda dependencies..."
    cd lambda && uv pip install -r aws_resource_cleanup/requirements.txt

# Bootstrap CDK (first time only)
bootstrap:
    @echo "Bootstrapping CDK in {{region}} with profile {{profile}}..."
    uv run cdk bootstrap aws://$(aws sts get-caller-identity --profile {{profile}} --query Account --output text)/{{region}} \
        --profile {{profile}} \
        --region {{region}}

# Synthesize CloudFormation template
synth:
    @echo "Synthesizing CloudFormation template..."
    uv run cdk synth --profile {{profile}} --region {{region}}

# Deploy in DRY_RUN mode (default, safe)
deploy:
    @echo "Deploying in DRY_RUN mode (safe)..."
    uv run cdk deploy \
        --profile {{profile}} \
        --region {{region}} \
        --require-approval never

# Deploy in LIVE mode (destructive, requires confirmation)
deploy-live:
    @echo "⚠️  WARNING: Deploying in LIVE mode (will delete resources!)"
    @echo "Press Ctrl+C to cancel, or Enter to continue..."
    @read _
    uv run cdk deploy \
        --profile {{profile}} \
        --region {{region}} \
        --parameters DryRunMode=false \
        --require-approval never

# Deploy with custom parameters
deploy-custom DRY_RUN="true" THRESHOLD="30" EMAIL="":
    @echo "Deploying with custom parameters..."
    uv run cdk deploy \
        --profile {{profile}} \
        --region {{region}} \
        --parameters DryRunMode={{DRY_RUN}} \
        --parameters UntaggedThresholdMinutes={{THRESHOLD}} \
        --parameters NotificationEmail={{EMAIL}}

# Destroy the stack (cleanup)
destroy:
    @echo "⚠️  WARNING: This will destroy the entire stack!"
    @echo "Press Ctrl+C to cancel, or Enter to continue..."
    @read _
    uv run cdk destroy --profile {{profile}} --region {{region}} --force

# Diff against deployed stack
diff:
    @echo "Comparing local changes with deployed stack..."
    uv run cdk diff --profile {{profile}} --region {{region}}

# Tail CloudWatch logs
logs:
    @echo "Tailing CloudWatch logs for Lambda..."
    aws logs tail /aws/lambda/{{lambda_function}} \
        --follow \
        --format short \
        --profile {{profile}} \
        --region {{region}}

# Tail recent logs (last hour)
logs-recent:
    @echo "Showing logs from last hour..."
    aws logs tail /aws/lambda/{{lambda_function}} \
        --since 1h \
        --format short \
        --profile {{profile}} \
        --region {{region}}

# Invoke Lambda manually (AWS)
invoke-aws:
    @echo "Invoking Lambda in AWS..."
    aws lambda invoke \
        --function-name {{lambda_function}} \
        --profile {{profile}} \
        --region {{region}} \
        --log-type Tail \
        /tmp/lambda-response.json
    @echo "\nResponse:"
    @cat /tmp/lambda-response.json | jq '.'
    @rm /tmp/lambda-response.json

# Get Lambda function info
info:
    @echo "Lambda function information:"
    aws lambda get-function \
        --function-name {{lambda_function}} \
        --profile {{profile}} \
        --region {{region}} \
        --query 'Configuration.{Name:FunctionName,Runtime:Runtime,Memory:MemorySize,Timeout:Timeout,Modified:LastModified,Architecture:Architectures[0]}' \
        --output table

# Run unit tests
test:
    @echo "Running unit tests..."
    PYTHONPATH=lambda:$$PYTHONPATH uv run --with pytest --with pytest-cov pytest tests/ -v --cov=aws_resource_cleanup

# Run unit tests with detailed coverage report
test-coverage:
    @echo "Running unit tests with coverage report..."
    PYTHONPATH=lambda:$$PYTHONPATH uv run --with pytest --with pytest-cov pytest tests/ -v --cov=aws_resource_cleanup --cov-report=term-missing

# Run linting
lint:
    @echo "Running linters..."
    uv run --with ruff ruff check lambda/aws_resource_cleanup/
    uv run --with black black --check lambda/aws_resource_cleanup/
    uv run --with mypy mypy lambda/aws_resource_cleanup/

# Format code
format:
    @echo "Formatting code..."
    uv run --with black black lambda/aws_resource_cleanup/
    uv run --with ruff ruff check --fix lambda/aws_resource_cleanup/

# Clean build artifacts
clean:
    @echo "Cleaning build artifacts..."
    rg -g '*.pyc' --files | xargs rm -f
    rg -g '__pycache__' --files | xargs rm -rf
    rm -rf cdk.out
    rm -rf .pytest_cache
    rm -rf tests/.pytest_cache
    rm -rf lambda/aws_resource_cleanup.egg-info
    rm -f /tmp/lambda-response.json

# Full CI pipeline (lint, test, synth)
ci: lint test synth
    @echo "✓ CI pipeline completed successfully"

# Watch for changes and auto-deploy
watch:
    @echo "Watching for changes (auto-deploy on save)..."
    uv run cdk watch --profile {{profile}} --region {{region}}

# Show stack outputs
outputs:
    @echo "Stack outputs:"
    aws cloudformation describe-stacks \
        --stack-name AWSResourcesCleanupStack \
        --profile {{profile}} \
        --region {{region}} \
        --query 'Stacks[0].Outputs' \
        --output table

# Show stack parameters
params:
    @echo "Stack parameters:"
    aws cloudformation describe-stacks \
        --stack-name AWSResourcesCleanupStack \
        --profile {{profile}} \
        --region {{region}} \
        --query 'Stacks[0].Parameters' \
        --output table

# List all Lambda functions
list-lambdas:
    @echo "All Lambda functions in {{region}}:"
    aws lambda list-functions \
        --profile {{profile}} \
        --region {{region}} \
        --query 'Functions[?starts_with(FunctionName, `Lambda`)].{Name:FunctionName,Runtime:Runtime,Size:CodeSize,Modified:LastModified}' \
        --output table

# Update Lambda code only (faster than full deploy)
update-code:
    @echo "Building Lambda package..."
    cd lambda && zip -r /tmp/lambda-code.zip aws_resource_cleanup/
    @echo "Updating Lambda function code..."
    aws lambda update-function-code \
        --function-name {{lambda_function}} \
        --zip-file fileb:///tmp/lambda-code.zip \
        --profile {{profile}} \
        --region {{region}}
    @rm /tmp/lambda-code.zip
    @echo "✓ Lambda code updated"

# Update Lambda environment variables
update-env DRY_RUN="true":
    @echo "Updating Lambda environment variables..."
    aws lambda update-function-configuration \
        --function-name {{lambda_function}} \
        --environment "Variables={DRY_RUN={{DRY_RUN}}}" \
        --profile {{profile}} \
        --region {{region}}
    @echo "✓ Environment updated to DRY_RUN={{DRY_RUN}}"

# Validate CloudFormation template
validate:
    @echo "Validating CloudFormation template..."
    uv run cdk synth --profile {{profile}} --region {{region}} > /tmp/template.yaml
    aws cloudformation validate-template \
        --template-body file:///tmp/template.yaml \
        --profile {{profile}} \
        --region {{region}}
    @rm /tmp/template.yaml
    @echo "✓ Template is valid"

# Upgrade all dependencies
upgrade:
    @echo "Upgrading CDK and Python dependencies..."
    uv pip install --upgrade aws-cdk-lib constructs boto3
    @echo "Upgrading dev tools..."
    uv pip install --upgrade pytest pytest-cov moto ruff black mypy
    @echo "✓ All dependencies upgraded"
    @echo "Run 'just synth' to verify CDK works"

# Show versions
versions:
    @echo "CDK version:"
    @uv run cdk --version
    @echo "\nPython packages:"
    @uv pip list | grep -E "(aws-cdk-lib|constructs|boto3|pytest|ruff|black|mypy)"
